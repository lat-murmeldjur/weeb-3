<!doctype html>
<html lang="en">
  <meta charset="utf-8" />
  <title>weeb-3 embed demo</title>
  <p>
    <label>
      Address:
      <input id="address" size="70"
             value="05f5dde6c936f92409ab2b1059b916ba4f4f20bdf36a86e3092a17fcf890996d946424770b822bd257f50adf9dcd4950df64c9ca1c462a19ded7634b01f04072" />
    </label>
    <button id="go">Retrieve</button>
  </p>

  <div id="viewerRoot"></div>
  <div id="meta"></div>
  <p id="fallback" hidden>
    Can’t preview this type. <a id="dl" href="#" download>Download file</a>
  </p>

  <script type="module">
    import init, { SekireiNo103 } from "./weeb-3/weeb_3.js";
    await init();

    const weeb3node = new SekireiNo103();
    weeb3node.start(
      "/ip4/49.12.172.37/tcp/32531/tls/sni/49-12-172-37.k2k4r8l8l5hzyp48440rjqlfdjpr03jfgioal93akbigy0tomtft4w44.libp2p.direct/ws/p2p/QmTFvqc5wMkbsXjqnTxQbVss5t8T1292BupJZ9VyU1GMRV",
      "10"
    );

    const viewerRoot = document.getElementById("viewerRoot");
    const meta       = document.getElementById("meta");
    const dl         = document.getElementById("dl");
    const fb         = document.getElementById("fallback");

    let currentUrl = null;

    function inferMimeFromName(name) {
      const ext = name.split(".").pop()?.toLowerCase();
      switch (ext) {
        case "jpg":
        case "jpeg": return "image/jpeg";
        case "png":  return "image/png";
        case "gif":  return "image/gif";
        case "webp": return "image/webp";
        case "pdf":  return "application/pdf";
        case "mp4":  return "video/mp4";
        case "webm": return "video/webm";
        case "mp3":  return "audio/mpeg";
        case "wav":  return "audio/wav";
        case "ogg":  return "audio/ogg";
        case "txt":  return "text/plain";
        case "json": return "application/json";
        case "html": return "text/html";
        default:     return "application/octet-stream";
      }
    }

    function formatBytes(n) {
      if (n < 1024) return `${n} B`;
      const u = ["KB","MB","GB","TB"];
      let i = -1;
      do { n /= 1024; i++; } while (n >= 1024 && i < u.length - 1);
      return `${n.toFixed(1)} ${u[i]}`;
    }

    function showFile(entry) {
      const { path, file } = entry;

      if (currentUrl) URL.revokeObjectURL(currentUrl);

      const url = URL.createObjectURL(file);
      currentUrl = url;

      const embed = document.createElement("embed");
      const mime = file.type && file.type.trim() !== ""
        ? file.type
        : inferMimeFromName(file.name || path);

      embed.setAttribute("type", mime);
      embed.setAttribute("src", url);

      viewerRoot.replaceChildren(embed);

      meta.textContent =
        `${path} — ${file.name || "(no name)"} — ${mime} — ${formatBytes(file.size)}`;

      if (dl) {
        dl.href = url;
        dl.download = file.name || path || "download";
      }
      if (fb) fb.hidden = true;
    }

    document.getElementById("go").addEventListener("click", async () => {
      const addr = document.getElementById("address").value.trim();
      meta.textContent = "";
      viewerRoot.replaceChildren(); // clear

      try {
        const entries = await weeb3node.retrieve(addr);

        if (entries.length === 0) {
          meta.textContent = "No files were returned for this address.";
          if (fb) fb.hidden = false;
          return;
        }

        showFile(entries[0]);
      } catch (e) {
        meta.textContent = "Retrieve failed: " + (e?.message ?? String(e));
        if (fb) fb.hidden = false;
      }
    });

    window.addEventListener("beforeunload", () => {
      if (currentUrl) URL.revokeObjectURL(currentUrl);
    });
  </script>
</html>
